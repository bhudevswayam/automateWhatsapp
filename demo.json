// console.log('hello world');

const axios = require('axios');
var express = require("express");
var bodyParser = require("body-parser");
const MongoClient = require('mongodb').MongoClient;

const mongoURI = "mongodb+srv://swayampandya1236:Hgm4dqVLM4KRAIKE@dummydb.kklcpad.mongodb.net/?retryWrites=true&w=majority";

const dbName = 'testdata';
var app = express();
app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());

app.get("/", function (req, res) {
  res.send(
    "Simple WhatsApp Webhook tester</br>There is no front-end, see server.js for implementation!"
  );
});

app.get("/webhook", function (req, res) {
  if (
    req.query["hub.mode"] == "subscribe" &&
    req.query["hub.verify_token"] == "mysecret"
  ) {
    res.send(req.query["hub.challenge"]);
  } else {
    res.sendStatus(400);
  }


  app.post('/webhook', async function (request, response) {
    try {
      const jsonData = request.body; // Parse the incoming JSON data
      console.log(JSON.stringify(jsonData, null, 2));
      console.dir(jsonData, { depth: null });
  
      if (jsonData.entry && jsonData.entry.length > 0) {
        const changes = jsonData.entry[0].changes;
        if (changes && changes.length > 0) {
          const messages = changes[0].value.messages;
          if (messages && messages.length > 0) {
            for (const message of messages) {
              if (message.type === 'text') {
                const textBody = message.text.body.toLowerCase();
                console.log('Incoming webhook: ' + textBody);
  
                if (textBody.includes('hi') || textBody.includes('hello')) {
                  // Postman environment variables
  
                  const postmanEnvironment = {
                    UserAccessToken: 'EAAN8IwQAAloBOxpcmM9iArWIA2tqtZAS7co0ktggaDhMDL7hcr1ZBqAr284oIJGaBTBZAaiQG8p7vfjp3RZAnNYcZCceFKZCzr3Rbg0QqZA4CLXsZBQF7ZC0mGVptgW9Y8Qtyy3rxLyBz4hTMpZAEAaEL8KZA4EPkHZBAqPFNswMFKBSVMpvrlOFzPtY9Ve5DoSBZBMZAgDtADRg9FtBmZAspwTzqwZD',
                  };
  
                  // WhatsApp API endpoint
                  const apiEndpoint = 'https://graph.facebook.com/v17.0/107124295779726/messages';
  
                  // JSON data for the POST request
                  const postData = {
                    messaging_product: 'whatsapp',
                    to: '918866271602',
                    type: 'template',
                    template: {
                      name: 'cake_hi_reply',
                      language: {
                        code: 'en',
                      },
                      components: [
                        {
                          type: "header",
                          parameters: [
                            {
                              type: "image",
                              image: {
                                link: "https://enterprise.press/wp-content/uploads/2020/12/monginis-1600px.jpg"
                              }
                            }
                          ]
                        }
                      ]
                    },
                  };
  
                  // Send the POST request using axios
                  axios.post(apiEndpoint, postData, {
                    headers: {
                      'Authorization': `Bearer ${postmanEnvironment.UserAccessToken}`,
                      'Content-Type': 'application/json',
                    }
                  })
                    .then(response => {
                      console.log('Message sent successfully:');
                    })
                    .catch(error => {
                      console.error('Error sending message:' + error);
                    });
  
                } else if (message.type === 'button') {
                  const buttonText = message.button.text.toLowerCase();
  
                  // Handle based on the button text
                  if (buttonText === 'catalog') {
                    // Postman environment variables
  
                    const postmanEnvironment = {
                      UserAccessToken: 'EAAN8IwQAAloBOxpcmM9iArWIA2tqtZAS7co0ktggaDhMDL7hcr1ZBqAr284oIJGaBTBZAaiQG8p7vfjp3RZAnNYcZCceFKZCzr3Rbg0QqZA4CLXsZBQF7ZC0mGVptgW9Y8Qtyy3rxLyBz4hTMpZAEAaEL8KZA4EPkHZBAqPFNswMFKBSVMpvrlOFzPtY9Ve5DoSBZBMZAgDtADRg9FtBmZAspwTzqwZD',
                    };
  
                    // WhatsApp API endpoint
                    const apiEndpoint = 'https://graph.facebook.com/v17.0/107124295779726/messages';
  
                    // JSON data for the POST request
                    const postData = {
                      messaging_product: 'whatsapp',
                      to: '918866271602',
                      type: 'template',
                      template: {
                        name: 'pickup',
                        language: {
                          code: 'en_US',
                        },
                      },
                    };
  
                    // Send the POST request using axios
                    axios.post(apiEndpoint, postData, {
                      headers: {
                        'Authorization': `Bearer ${postmanEnvironment.UserAccessToken}`,
                        'Content-Type': 'application/json',
                      }
                    })
                      .then(response => {
                        console.log('Message sent successfully:');
                      })
                      .catch(error => {
                        console.error('Error sending message:' + error);
                      });
  
                  } else if (buttonText === 'special offers') {
                    // Postman environment variables
  
                    const postmanEnvironment = {
                      UserAccessToken: 'EAAN8IwQAAloBOxpcmM9iArWIA2tqtZAS7co0ktggaDhMDL7hcr1ZBqAr284oIJGaBTBZAaiQG8p7vfjp3RZAnNYcZCceFKZCzr3Rbg0QqZA4CLXsZBQF7ZC0mGVptgW9Y8Qtyy3rxLyBz4hTMpZAEAaEL8KZA4EPkHZBAqPFNswMFKBSVMpvrlOFzPtY9Ve5DoSBZBMZAgDtADRg9FtBmZAspwTzqwZD',
                    };
  
                    // WhatsApp API endpoint
                    const apiEndpoint = 'https://graph.facebook.com/v17.0/107124295779726/messages';
  
                    // JSON data for the POST request
                    const postData = {
                      messaging_product: 'whatsapp',
                      to: '918866271602',
                      type: 'template',
                      template: {
                        name: 'delivery',
                        language: {
                          code: 'en_US',
                        },
                      },
                    };
  
                    // Send the POST request using axios
                    axios.post(apiEndpoint, postData, {
                      headers: {
                        'Authorization': `Bearer ${postmanEnvironment.UserAccessToken}`,
                        'Content-Type': 'application/json',
                      }
                    })
                      .then(response => {
                        console.log('Message sent successfully:');
                      })
                      .catch(error => {
                        console.error('Error sending message:' + error);
                      });
  
                  }
                }
              }
            }
          }
        }
      }
  
      response.sendStatus(200);
      } catch (error) {
        console.error('Error in /webhook:', error);
        response.sendStatus(500); // Respond with an error status
      }
    });
  

// app.post("/webhook", function (request, response) {
//   try {
//     const jsonData = request.body; // Parse the incoming JSON data
//     console.log(JSON.stringify(jsonData, null, 2));
//     console.dir(jsonData, { depth: null });
//     const buttonText = jsonData.entry[0].changes[0].value.messages[0].button.text;
//     if (jsonData.entry && jsonData.entry.length > 0) {
//       const changes = jsonData.entry[0].changes;
//       if (changes && changes.length > 0) {
//         const messages = changes[0].value.messages;
//         if (messages && messages.length > 0) {
//           const textBody = messages[0].text.body.toLowerCase();
//           console.log("Incoming webhook: " + textBody);

//             if (textBody.includes("hi") || textBody.includes("hello")) {
//             // Postman environment variables
            
//             const postmanEnvironment = {
//                 UserAccessToken: 'EAAN8IwQAAloBOxpcmM9iArWIA2tqtZAS7co0ktggaDhMDL7hcr1ZBqAr284oIJGaBTBZAaiQG8p7vfjp3RZAnNYcZCceFKZCzr3Rbg0QqZA4CLXsZBQF7ZC0mGVptgW9Y8Qtyy3rxLyBz4hTMpZAEAaEL8KZA4EPkHZBAqPFNswMFKBSVMpvrlOFzPtY9Ve5DoSBZBMZAgDtADRg9FtBmZAspwTzqwZD',
//               };
              
//               // WhatsApp API endpoint
//               const apiEndpoint = 'https://graph.facebook.com/v17.0/107124295779726/messages';
              
//               // JSON data for the POST request
//               const postData = {
//                 messaging_product: 'whatsapp',
//                 to: '918866271602',
//                 type: 'template',
//                 template: {
//                   name: 'cake_hi_reply',
//                   language: {
//                     code: 'en',
//                   },
//                   components: [
//                     {
//                       type: "header",
//                       parameters: [
//                         {
//                           type: "image",
//                           image: {
//                             link: "https://enterprise.press/wp-content/uploads/2020/12/monginis-1600px.jpg"
//                           }
//                         }
//                       ]
//                     }
//                   ]
//                 },
//               };
              
//               // Send the POST request using axios
//               axios.post(apiEndpoint, postData, {
//                 headers: {
//                   'Authorization': `Bearer ${postmanEnvironment.UserAccessToken}`,
//                   'Content-Type': 'application/json',
//                 }
//               })
//                 .then(response => {
//                   console.log('Message sent successfully:');
//                 })
//                 .catch(error => {
//                   console.error('Error sending message:' +error);
//                 });
            
//                 }
                
//             }
            
//         }
//     }
//     else if (buttonText === "Catalog") {
//       // Postman environment variables
      
//       const postmanEnvironment = {
//           UserAccessToken: 'EAAN8IwQAAloBOxpcmM9iArWIA2tqtZAS7co0ktggaDhMDL7hcr1ZBqAr284oIJGaBTBZAaiQG8p7vfjp3RZAnNYcZCceFKZCzr3Rbg0QqZA4CLXsZBQF7ZC0mGVptgW9Y8Qtyy3rxLyBz4hTMpZAEAaEL8KZA4EPkHZBAqPFNswMFKBSVMpvrlOFzPtY9Ve5DoSBZBMZAgDtADRg9FtBmZAspwTzqwZD',
//         };
        
//         // WhatsApp API endpoint
//         const apiEndpoint = 'https://graph.facebook.com/v17.0/107124295779726/messages';
        
//         // JSON data for the POST request
//         const postData = {
//           messaging_product: 'whatsapp',
//           to: '918866271602',
//           type: 'template',
//           template: {
//             name: 'pickup',
//             language: {
//               code: 'en_US',
//             },
//           },
//         };
        
//         // Send the POST request using axios
//         axios.post(apiEndpoint, postData, {
//           headers: {
//             'Authorization': `Bearer ${postmanEnvironment.UserAccessToken}`,
//             'Content-Type': 'application/json',
//           }
//         })
//           .then(response => {
//             console.log('Message sent successfully:');
//           })
//           .catch(error => {
//             console.error('Error sending message:' +error);
//           });
      
//           }
//   else if (buttonText === "Special Offers") {
//       // Postman environment variables
      
//       const postmanEnvironment = {
//           UserAccessToken: 'EAAN8IwQAAloBOxpcmM9iArWIA2tqtZAS7co0ktggaDhMDL7hcr1ZBqAr284oIJGaBTBZAaiQG8p7vfjp3RZAnNYcZCceFKZCzr3Rbg0QqZA4CLXsZBQF7ZC0mGVptgW9Y8Qtyy3rxLyBz4hTMpZAEAaEL8KZA4EPkHZBAqPFNswMFKBSVMpvrlOFzPtY9Ve5DoSBZBMZAgDtADRg9FtBmZAspwTzqwZD',
//         };
        
//         // WhatsApp API endpoint
//         const apiEndpoint = 'https://graph.facebook.com/v17.0/107124295779726/messages';
        
//         // JSON data for the POST request
//         const postData = {
//           messaging_product: 'whatsapp',
//           to: '918866271602',
//           type: 'template',
//           template: {
//             name: 'delivery',
//             language: {
//               code: 'en_US',
//             },
//           },
//         };
        
//         // Send the POST request using axios
//         axios.post(apiEndpoint, postData, {
//           headers: {
//             'Authorization': `Bearer ${postmanEnvironment.UserAccessToken}`,
//             'Content-Type': 'application/json',
//           }
//         })
//           .then(response => {
//             console.log('Message sent successfully:');
//           })
//           .catch(error => {
//             console.error('Error sending message:' +error);
//           });
      
//           }

//     response.sendStatus(200);
//   } catch (error) {
//     console.error("Error in /webhook:", error);
//     response.sendStatus(500); // Respond with an error status
//   }
// });

var listener = app.listen(process.env.PORT || 3001, function () {
  console.log("Your app is listening on port " + listener.address().port);
});


});